<!DOCTYPE html>
<html lang="en" class="h-full antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#111827" media="(prefers-color-scheme: dark)">
    <title>EliteCore.hosting bot</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                    colors: {
                        gray: {
                            850: '#1f2937',
                            900: '#111827',
                            950: '#030712', // Deep dark for OLED screens
                        }
                    },
                    screens: {
                        'xs': '475px', // Extra small devices
                        '3xl': '1600px', // Ultra-wide monitors
                    }
                }
            }
        }
    </script>

    <style>
        /* --- Universal Scrollbar Handling --- */
        /* Firefox */
        * { scrollbar-width: thin; scrollbar-color: #d1d5db transparent; }
        .dark * { scrollbar-color: #4b5563 transparent; }
        
        /* Chrome/Edge/Safari */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 20px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

        /* --- Markdown Styling --- */
        .prose pre { background-color: #1f2937; color: #e5e7eb; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 0.75rem 0; border: 1px solid #374151; }
        .prose code { background-color: rgba(0,0,0,0.05); padding: 0.1rem 0.3rem; border-radius: 0.25rem; font-size: 0.875em; font-family: 'Menlo', 'Monaco', 'Courier New', monospace; }
        .dark .prose code { background-color: rgba(255,255,255,0.1); }
        .prose p { margin-bottom: 0.75rem; line-height: 1.625; }
        .prose ul, .prose ol { padding-left: 1.5rem; margin-bottom: 0.75rem; }
        .prose ul { list-style-type: disc; }
        .prose ol { list-style-type: decimal; }
        .prose a { color: #3b82f6; text-decoration: underline; text-underline-offset: 2px; }
        .prose h1, .prose h2, .prose h3 { font-weight: 700; margin-top: 1.5rem; margin-bottom: 0.75rem; color: inherit; }

        /* --- Loader --- */
        #loading-screen { position: fixed; inset: 0; background: #ffffff; display: flex; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.4s ease; }
        .dark #loading-screen { background: #030712; color: white; }

        /* --- Mobile Optimizations --- */
        /* Prevents iOS text zoom on inputs */
        input, textarea { font-size: 16px !important; }
        /* Glassmorphism utilities */
        .glass-effect { backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
    </style>
</head>
<body class="bg-white dark:bg-gray-950 text-gray-900 dark:text-gray-100 h-[100dvh] w-full overflow-hidden flex flex-col transition-colors duration-200">

    <div id="loading-screen">
        <div class="flex flex-col items-center gap-4">
            <div class="relative w-10 h-10">
                <div class="absolute inset-0 border-4 border-blue-500/30 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
            </div>
            <div class="text-sm font-medium tracking-wide animate-pulse">ELITECORE BOT</div>
        </div>
    </div>

    <div id="app" class="flex h-full w-full opacity-0 transition-opacity duration-500">
        
        <div id="sidebar-overlay" class="fixed inset-0 bg-gray-900/60 z-30 hidden lg:hidden glass-effect transition-opacity" onclick="toggleSidebar(false)"></div>

        <div id="sidebar" class="fixed inset-y-0 left-0 z-40 w-[280px] bg-gray-50 dark:bg-gray-900 border-r border-gray-200 dark:border-gray-800 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col h-full shadow-2xl lg:shadow-none">
            
            <div class="p-4 flex items-center justify-between gap-2">
                <button onclick="createNewChat()" class="flex-1 flex items-center justify-center gap-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700 text-sm font-medium py-3 px-4 rounded-xl shadow-sm transition-all active:scale-95">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                    New Chat
                </button>
                <button onclick="toggleSidebar(false)" class="lg:hidden p-3 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-800 text-gray-500 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto px-3 py-2 space-y-1" id="chat-history-list">
                </div>

            <div class="p-4 border-t border-gray-200 dark:border-gray-800 bg-gray-50 dark:bg-gray-900">
                <button onclick="openSettings()" class="w-full flex items-center gap-3 p-3 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-800 transition-colors text-sm font-medium text-gray-700 dark:text-gray-300">
                    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Settings & API
                </button>
            </div>
        </div>

        <main class="flex-1 flex flex-col h-full relative w-full lg:ml-[280px] lg:w-[calc(100%-280px)] transition-all">
            
            <div class="lg:hidden h-14 min-h-[3.5rem] flex items-center justify-between px-4 border-b border-gray-100 dark:border-gray-800 bg-white/80 dark:bg-gray-950/80 glass-effect sticky top-0 z-20">
                <button onclick="toggleSidebar(true)" class="p-2 -ml-2 rounded-lg text-gray-600 dark:text-gray-300 active:bg-gray-100 dark:active:bg-gray-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <div class="font-semibold text-sm text-gray-800 dark:text-gray-200">EliteCore Bot</div>
                <div class="w-6"></div> </div>

            <div class="hidden lg:flex absolute top-4 right-6 z-10 pointer-events-none">
                <span id="current-model-display" class="text-xs font-mono text-gray-400 bg-gray-100 dark:bg-gray-900 px-2 py-1 rounded border border-gray-200 dark:border-gray-800 opacity-70">
                    Loading...
                </span>
            </div>

            <div id="chat-container" class="flex-1 overflow-y-auto px-4 py-4 space-y-6 scroll-smooth pb-36 w-full max-w-5xl mx-auto">
                <div id="welcome-message" class="flex flex-col items-center justify-center h-full text-center space-y-6 opacity-60 px-4">
                    <div class="w-20 h-20 bg-gradient-to-tr from-blue-500 to-indigo-600 rounded-3xl flex items-center justify-center text-white shadow-xl shadow-blue-500/20">
                        <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold tracking-tight text-gray-900 dark:text-white mb-2">EliteCore.hosting</h2>
                        <p class="text-gray-500 dark:text-gray-400 max-w-sm mx-auto">Universal AI Assistant optimized for PC, Tablet, and Mobile.</p>
                    </div>
                </div>
            </div>

            <div class="w-full bg-white dark:bg-gray-950/95 border-t border-gray-100 dark:border-gray-800 p-4 absolute bottom-0 z-20 backdrop-blur-sm">
                <div class="max-w-3xl mx-auto relative">
                    <div class="relative flex items-end gap-2 bg-gray-50 dark:bg-gray-900 rounded-[2rem] p-2 border border-gray-200 dark:border-gray-800 focus-within:border-blue-500 focus-within:ring-2 focus-within:ring-blue-500/20 transition-all shadow-sm">
                        
                        <textarea id="user-input" rows="1" class="w-full bg-transparent border-none text-gray-900 dark:text-gray-100 placeholder-gray-500 focus:ring-0 resize-none py-3 px-4 max-h-[150px] overflow-y-auto leading-relaxed" placeholder="Type a message..." oninput="autoResize(this)" onkeydown="handleEnter(event)"></textarea>
                        
                        <button id="send-btn" onclick="sendMessage()" class="mb-1 p-2.5 bg-blue-600 hover:bg-blue-700 active:scale-95 text-white rounded-full disabled:opacity-50 disabled:cursor-not-allowed disabled:active:scale-100 transition-all flex-shrink-0">
                            <svg id="send-icon" class="w-5 h-5 transform rotate-90 ml-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                            <svg id="loading-icon" class="w-5 h-5 animate-spin hidden" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        </button>
                    </div>
                    <div class="text-[10px] md:text-xs text-center text-gray-400 mt-2 select-none">AI can make mistakes. Check important info.</div>
                </div>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-50 hidden transition-opacity">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeSettings()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-md bg-white dark:bg-gray-900 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 flex flex-col max-h-[90vh]">
            <div class="p-6 overflow-y-auto">
                <h3 class="text-xl font-bold mb-6">Configuration</h3>
                
                <div class="space-y-5">
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">OpenRouter API Key</label>
                        <input type="password" id="setting-api-key" placeholder="sk-or-..." class="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">
                        <p class="text-xs text-gray-500">Stored locally on your device.</p>
                    </div>

                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Model ID</label>
                        <input type="text" id="setting-model" class="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 focus:ring-2 focus:ring-blue-500 outline-none transition-all font-mono text-sm">
                    </div>

                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">System Instruction</label>
                        <textarea id="setting-system-prompt" rows="3" class="w-full p-3 rounded-xl bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 focus:ring-2 focus:ring-blue-500 outline-none transition-all text-sm"></textarea>
                    </div>

                    <div class="flex items-center justify-between py-2 border-t border-gray-100 dark:border-gray-800 mt-2">
                        <span class="text-sm font-medium">Dark Mode</span>
                        <button onclick="toggleTheme()" class="relative inline-flex h-7 w-12 items-center rounded-full bg-gray-200 dark:bg-blue-600 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-900">
                            <span id="theme-indicator" class="translate-x-1 inline-block h-5 w-5 transform rounded-full bg-white shadow-sm transition-transform duration-200 dark:translate-x-6"></span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="p-4 border-t border-gray-100 dark:border-gray-800 flex justify-end gap-3 bg-gray-50 dark:bg-gray-900/50 rounded-b-2xl">
                <button onclick="closeSettings()" class="px-5 py-2.5 text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-800 rounded-lg transition-colors">Cancel</button>
                <button onclick="saveSettings()" class="px-5 py-2.5 text-sm font-medium bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-lg shadow-blue-500/30 transition-all active:scale-95">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="rename-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeRenameModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[85%] max-w-sm bg-white dark:bg-gray-900 rounded-2xl p-6 shadow-2xl border border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-bold mb-4">Rename Chat</h3>
            <input type="text" id="rename-input" class="w-full p-3 mb-6 rounded-xl bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 focus:ring-2 focus:ring-blue-500 outline-none">
            <div class="flex justify-end gap-2">
                <button onclick="closeRenameModal()" class="px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg">Cancel</button>
                <button onclick="confirmRename()" class="px-4 py-2 text-sm font-medium bg-blue-600 text-white rounded-lg">Rename</button>
            </div>
        </div>
    </div>

    <script>
        /* =========================================
           STATE & CONFIGURATION
           ========================================= */
        const STATE_KEY = 'elitecore_universal_v2';
        
        let state = {
            apiKey: '',
            model: 'deepseek/deepseek-r1:free',
            systemPrompt: 'You are EliteCore, a helpful, precise, and secure AI assistant.',
            theme: 'light',
            chats: [],
            currentChatId: null
        };

        const el = {
            app: document.getElementById('app'),
            loader: document.getElementById('loading-screen'),
            chatContainer: document.getElementById('chat-container'),
            welcomeMsg: document.getElementById('welcome-message'),
            userInput: document.getElementById('user-input'),
            sendBtn: document.getElementById('send-btn'),
            sendIcon: document.getElementById('send-icon'),
            loadingIcon: document.getElementById('loading-icon'),
            chatList: document.getElementById('chat-history-list'),
            sidebar: document.getElementById('sidebar'),
            sidebarOverlay: document.getElementById('sidebar-overlay'),
            modelDisplay: document.getElementById('current-model-display'),
            settingsModal: document.getElementById('settings-modal'),
            apiKeyInput: document.getElementById('setting-api-key'),
            modelInput: document.getElementById('setting-model'),
            sysPromptInput: document.getElementById('setting-system-prompt'),
            themeIndicator: document.getElementById('theme-indicator'),
            renameModal: document.getElementById('rename-modal'),
            renameInput: document.getElementById('rename-input')
        };

        let isGenerating = false;
        let abortController = null;
        let renameTargetId = null;

        /* =========================================
           INITIALIZATION
           ========================================= */
        function init() {
            loadState();
            applyTheme();
            
            // UI Initialization
            renderChatList();
            if (state.currentChatId) {
                loadChat(state.currentChatId);
            } else {
                createNewChat();
            }
            if(el.modelDisplay) el.modelDisplay.textContent = state.model.split('/').pop();

            // Smooth reveal
            setTimeout(() => {
                el.loader.style.opacity = '0';
                el.app.style.opacity = '1';
                setTimeout(() => { el.loader.style.display = 'none'; }, 400);
            }, 600);
        }

        /* =========================================
           STATE ENGINE
           ========================================= */
        function saveState() { localStorage.setItem(STATE_KEY, JSON.stringify(state)); }
        
        function loadState() {
            const saved = localStorage.getItem(STATE_KEY);
            if (saved) state = { ...state, ...JSON.parse(saved) };
        }

        /* =========================================
           THEME ENGINE
           ========================================= */
        function applyTheme() {
            if (state.theme === 'dark') {
                document.documentElement.classList.add('dark');
                el.themeIndicator.classList.add('translate-x-6', 'bg-blue-500');
                el.themeIndicator.classList.remove('translate-x-1', 'bg-white');
            } else {
                document.documentElement.classList.remove('dark');
                el.themeIndicator.classList.remove('translate-x-6', 'bg-blue-500');
                el.themeIndicator.classList.add('translate-x-1', 'bg-white');
            }
        }
        function toggleTheme() {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            applyTheme();
            saveState();
        }

        /* =========================================
           CHAT LOGIC
           ========================================= */
        function createNewChat() {
            const newChat = { id: Date.now().toString(), title: 'New Conversation', messages: [] };
            state.chats.unshift(newChat);
            state.currentChatId = newChat.id;
            saveState();
            renderChatList();
            renderMessages();
            if (window.innerWidth < 1024) toggleSidebar(false);
            el.userInput.focus();
        }

        function loadChat(id) {
            state.currentChatId = id;
            saveState();
            renderChatList();
            renderMessages();
            if (window.innerWidth < 1024) toggleSidebar(false);
        }

        function deleteChat(e, id) {
            e.stopPropagation();
            if (!confirm('Permanently delete this chat?')) return;
            state.chats = state.chats.filter(c => c.id !== id);
            state.currentChatId = state.chats.length > 0 ? state.chats[0].id : null;
            if (!state.currentChatId && state.chats.length === 0) createNewChat();
            else { saveState(); renderChatList(); renderMessages(); }
        }

        /* =========================================
           UI RENDERING
           ========================================= */
        function renderChatList() {
            el.chatList.innerHTML = '';
            state.chats.forEach(chat => {
                const isActive = chat.id === state.currentChatId;
                const div = document.createElement('div');
                div.className = `group flex items-center justify-between p-3 rounded-xl cursor-pointer transition-all duration-200 text-sm ${
                    isActive 
                    ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 font-semibold' 
                    : 'hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-700 dark:text-gray-400'
                }`;
                div.onclick = () => loadChat(chat.id);
                div.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <svg class="w-4 h-4 min-w-[16px] ${isActive ? 'text-blue-500' : 'text-gray-400'}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                        <span class="truncate">${escapeHtml(chat.title)}</span>
                    </div>
                    <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity ${isActive ? 'opacity-100' : ''}">
                        <button onclick="openRenameModal(event, '${chat.id}')" class="p-1.5 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg text-gray-500"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button>
                        <button onclick="deleteChat(event, '${chat.id}')" class="p-1.5 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-lg text-red-500"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                    </div>
                `;
                el.chatList.appendChild(div);
            });
        }

        function renderMessages() {
            const chat = state.chats.find(c => c.id === state.currentChatId);
            if (!chat) return;

            el.chatContainer.innerHTML = '';
            if (chat.messages.length === 0) {
                el.chatContainer.appendChild(el.welcomeMsg.cloneNode(true));
                return;
            }

            chat.messages.forEach(msg => appendMessageToDOM(msg.role, msg.content, false));
            scrollToBottom();
        }

        function appendMessageToDOM(role, content, animate = false) {
            const isUser = role === 'user';
            const wrapper = document.createElement('div');
            wrapper.className = `flex w-full mb-6 ${isUser ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            // Responsive Max Widths
            bubble.className = `max-w-[85%] md:max-w-[75%] lg:max-w-[65%] rounded-2xl px-5 py-4 text-[0.95rem] md:text-base leading-relaxed shadow-sm break-words ${
                isUser 
                ? 'bg-blue-600 text-white rounded-br-sm' 
                : 'bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 text-gray-800 dark:text-gray-100 rounded-bl-sm prose dark:prose-invert max-w-none'
            }`;

            if (isUser) bubble.textContent = content;
            else bubble.innerHTML = DOMPurify.sanitize(marked.parse(content));

            wrapper.appendChild(bubble);
            el.chatContainer.appendChild(wrapper);
            if (animate) scrollToBottom();
            return bubble;
        }

        /* =========================================
           API & NETWORK
           ========================================= */
        async function sendMessage() {
            const text = el.userInput.value.trim();
            if (!text || isGenerating) return;

            if (!state.apiKey) { alert('API Key missing. Please open Settings.'); openSettings(); return; }

            const chat = state.chats.find(c => c.id === state.currentChatId);
            chat.messages.push({ role: 'user', content: text });
            saveState();

            el.userInput.value = '';
            autoResize(el.userInput);
            renderMessages();

            isGenerating = true;
            updateUIState();
            
            const aiBubble = appendMessageToDOM('assistant', '', true);
            let fullResponse = '';

            try {
                abortController = new AbortController();
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${state.apiKey}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": window.location.href,
                        "X-Title": "EliteCore Bot"
                    },
                    body: JSON.stringify({
                        model: state.model,
                        messages: [{ role: 'system', content: state.systemPrompt }, ...chat.messages],
                        stream: true
                    }),
                    signal: abortController.signal
                });

                if (!response.ok) throw new Error(`API Error ${response.status}`);

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                            try {
                                const delta = JSON.parse(line.slice(6)).choices[0]?.delta?.content || "";
                                fullResponse += delta;
                                aiBubble.innerHTML = DOMPurify.sanitize(marked.parse(fullResponse));
                                scrollToBottom(); // Auto scroll on stream
                            } catch (e) { /* silent parse fail */ }
                        }
                    }
                }

                chat.messages.push({ role: 'assistant', content: fullResponse });
                if (chat.messages.length <= 2 && fullResponse.length > 5) generateTitle(text, chat.id);
                saveState();

            } catch (error) {
                if (error.name !== 'AbortError') {
                    aiBubble.innerHTML = `<span class="text-red-500 font-medium">Error: ${error.message}</span>`;
                    chat.messages.push({ role: 'assistant', content: `[Error: ${error.message}]` });
                    saveState();
                }
            } finally {
                isGenerating = false;
                abortController = null;
                updateUIState();
            }
        }

        function generateTitle(userTxt, chatId) {
            const chat = state.chats.find(c => c.id === chatId);
            if(chat) {
                chat.title = userTxt.length > 30 ? userTxt.substring(0, 30) + '...' : userTxt;
                saveState();
                renderChatList();
            }
        }

        /* =========================================
           UTILITIES
           ========================================= */
        function updateUIState() {
            if (isGenerating) {
                el.sendIcon.classList.add('hidden');
                el.loadingIcon.classList.remove('hidden');
                el.sendBtn.onclick = () => abortController?.abort();
                el.sendBtn.classList.replace('bg-blue-600', 'bg-red-500');
            } else {
                el.sendIcon.classList.remove('hidden');
                el.loadingIcon.classList.add('hidden');
                el.sendBtn.onclick = sendMessage;
                el.sendBtn.classList.replace('bg-red-500', 'bg-blue-600');
            }
        }

        function toggleSidebar(show) {
            if (show) {
                el.sidebar.classList.remove('-translate-x-full');
                el.sidebarOverlay.classList.remove('hidden');
                setTimeout(() => el.sidebarOverlay.classList.remove('hidden'), 10); 
            } else {
                el.sidebar.classList.add('-translate-x-full');
                el.sidebarOverlay.classList.add('hidden');
            }
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
        }

        function handleEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                // On mobile, maybe don't submit on enter? User choice. Here we submit.
                sendMessage(); 
            }
        }

        function scrollToBottom() { 
            // Smooth scroll for nicer feel on all devices
            el.chatContainer.scrollTo({ top: el.chatContainer.scrollHeight, behavior: 'smooth' });
        }

        function escapeHtml(text) {
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        // Modal Helpers
        function openSettings() { 
            el.apiKeyInput.value = state.apiKey; 
            el.modelInput.value = state.model; 
            el.sysPromptInput.value = state.systemPrompt;
            el.settingsModal.classList.remove('hidden'); 
        }
        function closeSettings() { el.settingsModal.classList.add('hidden'); }
        function saveSettings() {
            state.apiKey = el.apiKeyInput.value.trim();
            state.model = el.modelInput.value.trim();
            state.systemPrompt = el.sysPromptInput.value.trim();
            if(el.modelDisplay) el.modelDisplay.textContent = state.model.split('/').pop();
            saveState(); closeSettings();
        }

        function openRenameModal(e, id) {
            e.stopPropagation(); renameTargetId = id;
            const chat = state.chats.find(c => c.id === id);
            if(chat) { el.renameInput.value = chat.title; el.renameModal.classList.remove('hidden'); el.renameInput.focus(); }
        }
        function closeRenameModal() { el.renameModal.classList.add('hidden'); renameTargetId = null; }
        function confirmRename() {
            if (renameTargetId && el.renameInput.value.trim()) {
                const chat = state.chats.find(c => c.id === renameTargetId);
                if (chat) { chat.title = el.renameInput.value.trim(); saveState(); renderChatList(); }
            }
            closeRenameModal();
        }

        // Boot
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
